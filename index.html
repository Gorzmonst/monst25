<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow"> <!-- 検索エンジンインデックス防止 -->
    <title>画像マッチングアプリ</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script> <!-- Pyodide 最新版 -->
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f0f0;
            display: none; /* 初期状態で非表示 */
        }
        canvas, img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
        }
        #result, #initialResult {
            margin-top: 20px;
            font-size: 18px;
            white-space: pre-wrap;
        }
        .button-container {
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>大魔王ぴよまる様の崇高なアプリ (Web版)</h1>

    <div>
        <label for="imageUpload">画像をアップロード:</label><br>
        <input type="file" id="imageUpload" accept="image/*" onchange="loadImage(event)">
    </div>

    <div>
        <label for="threshold">整合率 (0-1):</label><br>
        <input type="number" id="threshold" step="0.001" min="0" max="1" value="0.965" readonly> <!-- 閾値は固定 -->
        <div class="button-container">
            <button onclick="alert('このアプリでは閾値は0.965に固定されています。')">0.965</button>
        </div>
    </div>

    <div class="button-container">
        <button onclick="checkImage()">画像チェック</button>
        <button onclick="initialPositionCheck()">初期位置チェック</button>
    </div>

    <!-- 結果表示をキャンバスの上に配置 -->
    <div id="result">ここに結果が表示されます</div>
    <div id="initialResult">ここに初期位置が表示されます</div>

    <canvas id="canvas"></canvas>

    <!-- 結果画像を表示（デザインに影響を与えない位置） -->
    <img id="resultImage" src="" alt="マッチ結果がここに表示されます" style="margin-top: 20px;">

    <script>
        // 簡易パスワード保護
        (function() {
            const correctPassword = "kanatanpyonsu"; // パスワードを「kanatanpyonsu」に設定
            const password = prompt("パスワードを入力してください:");
            console.log("入力されたパスワード: ", password); // デバッグ用

            if (password !== correctPassword || password === null) {
                console.log("パスワードが間違っています。リダイレクトします。");
                alert("パスワードが間違っています。");
                // リダイレクトを確実にするために window.location.replace を使用
                window.location.replace("about:blank");
                // リダイレクトが失敗した場合に備えて、ページの読み込みを停止
                throw new Error("パスワード認証に失敗しました。ページの読み込みを停止します。");
            } else {
                console.log("パスワード認証に成功しました。ページを表示します。");
                // パスワードが正しい場合、ページを表示
                document.body.style.display = "block";
            }
        })();

        let pyodide = null;
        let pyodideReady = false;
        let uploadedImage = null;
        let coordinates = {};
        let templateBytes = null;

        // テンプレート画像（提供されたBase64形式）
        const templateBase64 = "iVBORw0KGgoAAAANSUhEUgAAAA4AAAAwCAIAAACuWtxbAAAACXBIWXMAAAsTAAALEwEAmpwYAAADcElEQVRIiXWUzU4bSxCFz6mqbo89tnPFDcoVERs2WWSVB8hzRHnW7NhEyiuwiUDBJOJHIAIBd1dlMZ6xDdzWaBbT31RXnVNdvFqcpmacmsbu73l5yYsLnJ/Hz584PcVigcWCEXj3Du/f2z/tFMslrq/x6xeOj3FyEicnOD7G9+/x4wfPz2MyoRn29iy+fcNigbOz1fviAtfXcXPtNze4vZWHB87nMZtxZ8fi61ccHeHoCGcLXF7h7g61hrsTAAhAldNpzOdWvnzB1SWuruL2Fn/+oFZEAHCAQASEVFWaWT08DCIIBBBYr+ijkhRRVavooryw2KH9skoiAi/RHTrsWMxmeHzE42O4xzO0+6Jr9PdvlBLuvp1thw4/SPPpU/r4kW/fxmTiqhUoLz0VsNHnz8vDQ7+8LHd3tRSvdVCCgAAACqCAcW8vdnfrdFpyriqVQKxRB0SEk4lMpxa7u7GzU9u25FREfK3pSoGqyra1+dwiIshCVrIQ/kwEJcMMKVksl+FeI7r0n6NGhgjMDIHB9ArUbYfYlU86YORqK3oU27T2ellQwqzmXM0K+SQqAAM6ayxEPefaNCXnIvIcrX0B5hFQjZTcrJLlGVp67cyrg4Sqiw4oN9QdZDGSQTrp5AtliYQqzcTMVLWrvWwosFKKFBGmpDlrziYiATjgvSgbEYVmSIk5S0o2bAyx14qSkjNGI6QUqtZlP+i/iQapqmEWqqAYI7yHniQQvVUBgDAyYrvhn6B10JUM374YT/RfoyCCDLNqVillQ/0hakcbhJKzzWbSttVSgQxzZsi1ow1CmmnbyngcqqWbIIMCZBWppIMGd6hiNIqcXcQ3ZxcZOXM00pRUxOAOEaQEs64NhptIEeTMppGcRdRQVkX7RgUBBKGmHDfatjIahYihOvrtoV1WXaHCptHxmDkHxYLaWbDcsGDzz7WuAfH/cWszJRAWq7m0OnS4HgB0eyzY0PLDib52cnOG0oKMiFprqXXpvnQfLPBAjf7GEgbQI2opyw6NkO6ggMcq++EQakp5NsuTCVWHggKoZKhCFSQCgqCm1MxmuW1VlZtK9YMNJBAGQMysaZjzUuShbxQnTdXNoAqRCBgCFNGckfOjyP3QKKrZbIWSCJh7WNO0r1//e3Cw/+FD++ZNh0KkffXqv/393YODZj53978STunEdILQwwAAAABJRU5ErkJggg==";

        // Pyodide の初期化
        async function loadPyodideAndPackages() {
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(["opencv-python", "numpy"]);
                pyodideReady = true;
                console.log("Pyodide is ready");
                alert("Pyodide が読み込まれました！");

                // テンプレート画像をBase64からデコード
                templateBytes = Uint8Array.from(atob(templateBase64), c => c.charCodeAt(0));
                console.log("テンプレート画像（Base64）がデコードされました");
                alert("テンプレート画像（Base64）がデコードされました");
            } catch (error) {
                console.error("Pyodide の読み込みに失敗しました: ", error);
                alert("Pyodide の読み込みに失敗しました: " + error.message);
            }
        }

        // ページ読み込み時に Pyodide を初期化
        loadPyodideAndPackages();

        // ページ読み込み時にデバッグログを追加
        window.onload = function() {
            console.log("ページが読み込まれました");
            alert("ページが読み込まれました。"); // デバッグ用アラート
        };

        // 画像を読み込む
        function loadImage(event) {
            console.log("loadImage が呼び出されました"); // デバッグ用
            alert("loadImage が呼び出されました"); // デバッグ用アラート
            const file = event.target.files[0];
            if (!file) {
                console.log("ファイルが選択されていません");
                alert("ファイルが選択されていません");
                return;
            }
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;

                img.onload = function() {
                    uploadedImage = img;
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    console.log("画像がキャンバスに描画されました");
                    alert("画像がアップロードされました"); // デバッグ用アラート
                };
                img.onerror = function() {
                    console.log("画像の読み込みに失敗しました");
                    alert("画像の読み込みに失敗しました");
                };
            };
            reader.readAsDataURL(file);
        }

        // 画像チェック（Pyodide ベースのテンプレートマッチング）
        async function checkImage() {
            console.log("checkImage が呼び出されました"); // デバッグ用
            alert("画像チェックが呼び出されました"); // デバッグ用アラート
            if (!pyodideReady) {
                console.log("pyodideReady: ", pyodideReady);
                alert("Pyodide がまだ準備できていません。ページをリロードしてみてください。");
                return;
            }
            if (!uploadedImage) {
                console.log("uploadedImage: ", uploadedImage);
                alert("画像をアップロードしてください。");
                return;
            }
            if (!templateBytes) {
                console.log("templateBytes: ", templateBytes);
                alert("テンプレート画像（Base64）が読み込まれていません。ページをリロードしてみてください。");
                return;
            }

            try {
                const positions = await runMatching(false);
                console.log("検出された位置: ", positions); // デバッグ用
                alert("検出された位置: " + JSON.stringify(positions)); // デバッグ用アラート

                // 結果表示
                displayResults(positions);
            } catch (error) {
                console.error("画像チェック中にエラーが発生しました: ", error);
                alert("画像チェック中にエラーが発生しました: " + error.message + "\nスタック: " + error.stack);
            }
        }

        // 初期位置チェック（Pyodide ベースのテンプレートマッチング）
        async function initialPositionCheck() {
            console.log("initialPositionCheck が呼び出されました"); // デバッグ用
            alert("初期位置チェックが呼び出されました"); // デバッグ用アラート
            if (!pyodideReady) {
                console.log("pyodideReady: ", pyodideReady);
                alert("Pyodide がまだ準備できていません。ページをリロードしてみてください。");
                return;
            }
            if (!uploadedImage) {
                console.log("uploadedImage: ", uploadedImage);
                alert("画像をアップロードしてください。");
                return;
            }
            if (!templateBytes) {
                console.log("templateBytes: ", templateBytes);
                alert("テンプレート画像（Base64）が読み込まれていません。ページをリロードしてみてください。");
                return;
            }

            try {
                const positions = await runMatching(true);
                console.log("検出された位置: ", positions); // デバッグ用
                alert("検出された位置: " + JSON.stringify(positions)); // デバッグ用アラート

                // 結果表示
                displayInitialResults(positions);
            } catch (error) {
                console.error("初期位置チェック中にエラーが発生しました: ", error);
                alert("初期位置チェック中にエラーが発生しました: " + error.message + "\nスタック: " + error.stack);
            }
        }

        // Pyodide ベースのテンプレートマッチング
        async function runMatching(isInitial) {
            const threshold = 0.965; // 閾値を固定
            const imageInput = document.getElementById("imageUpload");
            const imgEl = document.getElementById("resultImage");

            if (imageInput.files.length === 0) {
                throw new Error("対象画像を選択してください。");
            }

            const imageFile = imageInput.files[0];
            const imageExt = imageFile.name.split('.').pop().toLowerCase();
            const imageName = "uploaded." + imageExt;

            const imageBytes = new Uint8Array(await imageFile.arrayBuffer());
            pyodide.FS.writeFile('template.png', templateBytes); // テンプレート画像（Base64）
            pyodide.FS.writeFile(imageName, imageBytes);

            const pythonCode = `
import cv2
import numpy as np
import base64

log = []
try:
    log.append("🔹 template 読み込み中...")
    template = cv2.imread("template.png", 0)
    if template is None:
        raise Exception("テンプレート画像の読み込みに失敗")

    log.append("🔹 対象画像 読み込み中...")
    img_color = cv2.imread("${imageName}")
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)

    log.append("🔹 テンプレートマッチング実行中...")
    res = cv2.matchTemplate(img_gray, template, cv2.TM_CCOEFF_NORMED)
    log.append("🔹 閾値 ${threshold} 以上を抽出中...")
    loc = np.where(res >= ${threshold})
    result = list(zip(*loc[::-1]))

    min_distance = 10
    final_result = []
    for pt in result:
        add = True
        for other_pt in final_result:
            dist = np.linalg.norm(np.array(pt) - np.array(other_pt))
            if dist < min_distance:
                add = False
                break
        if add:
            final_result.append(pt)

    final_result_sorted = sorted(final_result, key=lambda x: x[0])

    # テンプレート画像のサイズを取得
    h, w = template.shape
    log.append(f"テンプレート画像のサイズ: 幅={w}, 高さ={h}")

    # 中心座標に変換した結果を格納（浮動小数点で計算）
    final_result_centered = [(pt[0] + w / 2.0, pt[1] + h / 2.0) for pt in final_result_sorted]

    # デバッグ用：元の左上座標もログに出力
    if final_result_sorted:
        log.append("元の左上座標（デバッグ用）:")
        for pt in final_result_sorted:
            log.append(f"X: {pt[0]}, Y: {pt[1]}")

    if final_result_sorted:
        log.append("✅ マッチ箇所が見つかりました（中心座標）:")
        if len(final_result_sorted) > 5:
            log.append("⚠️ マッチ箇所が多すぎます。閾値を調整するか、範囲を狭めてください。")
        for pt in final_result_centered:
            log.append(f"X: {pt[0]}, Y: {pt[1]}")
            # 結果画像には中心座標を基準に矩形と中心点を描画
            pt_left_top = (int(pt[0] - w / 2.0), int(pt[1] - h / 2.0))
            pt_right_bottom = (int(pt[0] + w / 2.0), int(pt[1] + h / 2.0))
            cv2.rectangle(img_color, pt_left_top, pt_right_bottom, (0, 0, 255), 2)
            cv2.circle(img_color, (int(pt[0]), int(pt[1])), 10, (0, 255, 0), 2)
    else:
        log.append("⚠️ マッチなし")

    cv2.imwrite("result.png", img_color)

    with open("result.png", "rb") as f:
        img_bytes = f.read()
    img_base64 = base64.b64encode(img_bytes).decode("utf-8")

except Exception as e:
    log.append("❌ エラー: " + str(e))
    img_base64 = ""

"\\n".join(log) + "\\n__SPLIT__\\n" + img_base64 + "\\n__SPLIT__\\n" + str(final_result_centered)
`;

            try {
                const result = await pyodide.runPythonAsync(pythonCode);
                const [logText, imgBase64, positionsStr] = result.split("__SPLIT__");
                console.log("Pyodide ログ: ", logText);
                alert("Pyodide ログ:\n" + logText);

                // 結果画像を表示
                if (imgBase64) {
                    imgEl.src = "data:image/png;base64," + imgBase64;
                } else {
                    imgEl.src = "";
                }

                // 位置情報をパース（中心座標として受け取る）
                const positions = JSON.parse(positionsStr);
                return positions;
            } catch (err) {
                console.error("Pyodide 実行エラー: ", err);
                throw new Error("Pyodide 実行エラー:\n" + err);
            }
        }

        // 結果表示（通常チェック）
        function displayResults(positions) {
            console.log("displayResults が呼び出されました: ", positions); // デバッグ用
            const resultDiv = document.getElementById('result');
            coordinates = {};
            if (positions.length > 0) {
                const resultText = positions.map((pos, i) => `${i + 1}p : (${pos[0].toFixed(1)}, ${pos[1].toFixed(1)})`).join('\n');
                resultDiv.textContent = resultText;
                positions.forEach((pos, i) => coordinates[`${i + 1}P`] = pos);
            } else {
                resultDiv.textContent = "キャラクターが見つかりませんでした。";
                alert("キャラクターが見つかりませんでした。\nテンプレート画像がアップロードした画像内に存在するか確認してください。");
            }
        }

        // 初期位置結果表示（CSVデータは仮置き）
        function displayInitialResults(positions) {
            console.log("displayInitialResults が呼び出されました: ", positions); // デバッグ用
            const initialResultDiv = document.getElementById('initialResult');
            // 仮のCSVデータ
            const csvData = {
                '100,150': { initial_position: 'A', string_to_show: 'スタート地点' },
                '200,300': { initial_position: 'B', string_to_show: '中間地点' }
            };
            if (positions.length > 0) {
                const resultText = positions.map((pos, i) => {
                    const key = `${Math.round(pos[0])},${Math.round(pos[1])}`;
                    const data = csvData[key] || { initial_position: '', string_to_show: '不明' };
                    return `${i + 1}p : ${data.initial_position} ${data.string_to_show}`;
                }).join('\n');
                initialResultDiv.textContent = resultText;
            } else {
                initialResultDiv.textContent = "キャラクターが見つかりませんでした。";
                alert("キャラクターが見つかりませんでした。\nテンプレート画像がアップロードした画像内に存在するか確認してください。");
            }
        }
    </script>
</body>
</html>