// 画像チェック（Pyodide ベースのテンプレートマッチング）
async function checkImage() {
    console.log("checkImage が呼び出されました"); // デバッグ用
    if (!pyodideReady) {
        console.log("pyodideReady: ", pyodideReady);
        alert("Pyodide がまだ準備できていません。ページをリロードしてみてください。");
        return;
    }
    if (!uploadedImage) {
        console.log("uploadedImage: ", uploadedImage);
        alert("画像をアップロードしてください。");
        return;
    }
    if (!templateBytes) {
        console.log("templateBytes: ", templateBytes);
        alert("テンプレート画像（Base64）が読み込まれていません。ページをリロードしてみてください。");
        return;
    }

    try {
        const positions = await runMatching(false);
        console.log("検出された位置: ", positions); // デバッグ用
        // 結果をアラートではなく displayResults で表示
        displayResults(positions);
    } catch (error) {
        console.error("画像チェック中にエラーが発生しました: ", error);
        alert("画像チェック中にエラーが発生しました: " + error.message + "\nスタック: " + error.stack);
    }
}

// Pyodide ベースのテンプレートマッチング
async function runMatching(isInitial) {
    const threshold = parseFloat(document.getElementById("threshold").value); // 閾値を動的に取得
    const imageInput = document.getElementById("imageUpload");
    const imgEl = document.getElementById("resultImage");

    if (imageInput.files.length === 0) {
        throw new Error("対象画像を選択してください。");
    }

    const imageFile = imageInput.files[0];
    const imageExt = imageFile.name.split('.').pop().toLowerCase();
    const imageName = "uploaded." + imageExt;

    const imageBytes = new Uint8Array(await imageFile.arrayBuffer());
    pyodide.FS.writeFile('template.png', templateBytes); // テンプレート画像（Base64）
    pyodide.FS.writeFile(imageName, imageBytes);

    const pythonCode = `
import cv2
import numpy as np
import base64

log = []
try:
    log.append("🔹 template 読み込み中...")
    template = cv2.imread("template.png", 0)
    if template is None:
        raise Exception("テンプレート画像の読み込みに失敗")

    log.append("🔹 対象画像 読み込み中...")
    img_color = cv2.imread("${imageName}")
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)

    log.append("🔹 テンプレートマッチング実行中...")
    res = cv2.matchTemplate(img_gray, template, cv2.TM_CCOEFF_NORMED)
    log.append("🔹 閾値 ${threshold} 以上を抽出中...")
    loc = np.where(res >= ${threshold})
    result = list(zip(*loc[::-1]))

    min_distance = 10
    final_result = []
    for pt in result:
        add = True
        for other_pt in final_result:
            dist = np.linalg.norm(np.array(pt) - np.array(other_pt))
            if dist < min_distance:
                add = False
                break
        if add:
            final_result.append(pt)

    final_result_sorted = sorted(final_result, key=lambda x: x[0])

    # テンプレート画像のサイズを取得
    h, w = template.shape
    log.append(f"テンプレート画像のサイズ: 幅={w}, 高さ={h}")

    # 中心座標に変換した結果を格納（浮動小数点で計算）
    final_result_centered = [(pt[0] + w / 2.0, pt[1] + h / 2.0) for pt in final_result_sorted]

    if final_result_sorted:
        log.append("✅ マッチ箇所が見つかりました（中心座標）:")
        if len(final_result_sorted) > 5:
            log.append("⚠️ マッチ箇所が多すぎます。閾値を調整するか、範囲を狭めてください。")
        for pt in final_result_centered:
            log.append(f"X: {pt[0]}, Y: {pt[1]}")
            pt_left_top = (int(pt[0] - w / 2.0), int(pt[1] - h / 2.0))
            pt_right_bottom = (int(pt[0] + w / 2.0), int(pt[1] + h / 2.0))
            cv2.rectangle(img_color, pt_left_top, pt_right_bottom, (0, 0, 255), 2)
            cv2.circle(img_color, (int(pt[0]), int(pt[1])), 10, (0, 255, 0), 2)
    else:
        log.append("⚠️ マッチなし")

    cv2.imwrite("result.png", img_color)

    with open("result.png", "rb") as f:
        img_bytes = f.read()
    img_base64 = base64.b64encode(img_bytes).decode("utf-8")

except Exception as e:
    log.append("❌ エラー: " + str(e))
    img_base64 = ""

"\\n".join(log) + "\\n__SPLIT__\\n" + img_base64 + "\\n__SPLIT__\\n" + str(final_result_centered)
`;

    try {
        const result = await pyodide.runPythonAsync(pythonCode);
        const [logText, imgBase64, positionsStr] = result.split("__SPLIT__");
        console.log("Pyodide ログ: ", logText);

        // 結果画像を表示
        if (imgBase64) {
            imgEl.src = "data:image/png;base64," + imgBase64;
        } else {
            imgEl.src = "";
        }

        // 位置情報をパース（中心座標として受け取る）
        const positions = JSON.parse(positionsStr);
        return positions;
    } catch (err) {
        console.error("Pyodide 実行エラー: ", err);
        throw new Error("Pyodide 実行エラー:\n" + err);
    }
}