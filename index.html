<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>大魔王ぴよまる様の崇高なアプリ(WEB版)</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      text-align: center; 
    }
    pre { 
      background: #f0f0f0; 
      padding: 10px; 
      white-space: pre-wrap; 
      margin: 0 auto; 
      max-width: 600px; 
    }
    img { 
      max-width: 100%; 
      margin-top: 10px; 
    }
    .container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 10px; 
    }
    #password-screen, #main-content { 
      display: none; 
    }
    #password-screen.active, #main-content.active { 
      display: block; 
    }
  </style>
</head>
<body>
  <div id="password-screen" class="active">
    <h1>パスワードを入力してください</h1>
    <input type="password" id="password-input" placeholder="パスワード">
    <button onclick="checkPassword()">送信</button>
    <p id="password-error" style="color: red;"></p>
  </div>

  <div id="main-content" class="container">
    <h1>大魔王ぴよまる様の崇高なアプリ(WEB版)</h1>

    <label for="threshold">閾値 (0〜1):</label>
    <input type="number" id="threshold" min="0" max="1" step="0.0001" value="0.9500"><br>

    <label for="imageInput">対象画像 (.png, .jpg, .jpeg):</label>
    <input type="file" id="imageInput" accept="image/*"><br>

    <button onclick="runMatching()">スタート</button>

    <h2>結果ログ:</h2>
    <pre id="output">ここにログが表示されます</pre>

    <h2>マッチ結果画像:</h2>
    <img id="resultImage" src="" alt="マッチ結果がここに表示されます">
  </div>

  <script>
    const CORRECT_PASSWORD = "kanatanpyonsu";
    const TEMPLATE_URL = "https://raw.githubusercontent.com/Gorzmonst/monst25/main/1v2iPhone16_2.png"; // リポジトリに基づくURL

    function checkPassword() {
      const input = document.getElementById("password-input").value;
      const errorEl = document.getElementById("password-error");
      if (input === CORRECT_PASSWORD) {
        document.getElementById("password-screen").classList.remove("active");
        document.getElementById("main-content").classList.add("active");
      } else {
        errorEl.textContent = "パスワードが間違っています。";
      }
    }

    let pyodide = null;

    async function loadPyodideAndPackages() {
      pyodide = await loadPyodide();
      await pyodide.loadPackage(["opencv-python", "numpy"]);
    }

    loadPyodideAndPackages();

    async function runMatching() {
      const threshold = parseFloat(document.getElementById("threshold").value);
      const imageInput = document.getElementById("imageInput");
      const outputEl = document.getElementById("output");
      const imgEl = document.getElementById("resultImage");

      if (imageInput.files.length === 0) {
        outputEl.textContent = "❗ 対象画像を選択してください。";
        imgEl.src = "";
        return;
      }

      if (isNaN(threshold) || threshold < 0 || threshold > 1) {
        outputEl.textContent = "❗ 閾値は 0〜1 の間で入力してください。";
        imgEl.src = "";
        return;
      }

      // テンプレート画像をGitHubからフェッチ
      const templateResponse = await fetch(TEMPLATE_URL);
      if (!templateResponse.ok) {
        outputEl.textContent = "❌ テンプレート画像の読み込みに失敗しました。";
        return;
      }
      const templateArrayBuffer = await templateResponse.arrayBuffer();
      const templateBytes = new Uint8Array(templateArrayBuffer);
      pyodide.FS.writeFile('template.png', templateBytes);

      // アップロードされた画像を処理
      const imageFile = imageInput.files[0];
      const imageExt = imageFile.name.split('.').pop().toLowerCase();
      const imageName = "uploaded." + imageExt;
      const imageBytes = new Uint8Array(await imageFile.arrayBuffer());
      pyodide.FS.writeFile(imageName, imageBytes);

      const pythonCode = `
import cv2
import numpy as np
import base64

log = []
try:
    log.append("🔹 template 読み込み中...")
    template = cv2.imread("template.png", 0)
    if template is None:
        raise Exception("テンプレート画像の読み込みに失敗")

    log.append("🔹 対象画像 読み込み中...")
    img_color = cv2.imread("${imageName}")
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)

    log.append("🔹 テンプレートマッチング実行中...")
    res = cv2.matchTemplate(img_gray, template, cv2.TM_CCOEFF_NORMED)
    log.append("🔹 閾値 ${threshold} 以上を抽出中...")
    loc = np.where(res >= ${threshold})
    result = list(zip(*loc[::-1]))

    min_distance = 10
    final_result = []
    for pt in result:
        add = True
        for other_pt in final_result:
            dist = np.linalg.norm(np.array(pt) - np.array(other_pt))
            if dist < min_distance:
                add = False
                break
        if add:
            final_result.append(pt)

    final_result_sorted = sorted(final_result, key=lambda x: x[0])

    if final_result_sorted:
        log.append("✅ マッチ箇所が見つかりました:")
        if len(final_result_sorted) > 5:
            log.append("⚠️ マッチ箇所が多すぎます。閾値を調整するか、範囲を狭めてください。")
        h, w = template.shape
        for pt in final_result_sorted:
            log.append(f"マッチ箇所 左上座標: X: {pt[0]}, Y: {pt[1]}")
            center_x = pt[0] + w // 2
            center_y = pt[1] + h // 2
            log.append(f"マッチ箇所 中心座標: X: {center_x}, Y: {center_y}")
            cv2.rectangle(img_color, pt, (pt[0] + w, pt[1] + h), (0, 0, 255), 2)
            cv2.circle(img_color, (center_x, center_y), 10, (0, 255, 0), 2)
    else:
        log.append("⚠️ マッチなし")

    cv2.imwrite("result.png", img_color)

    with open("result.png", "rb") as f:
        img_bytes = f.read()
    img_base64 = base64.b64encode(img_bytes).decode("utf-8")

except Exception as e:
    log.append("❌ エラー: " + str(e))
    img_base64 = ""

"\\n".join(log) + "\\n__SPLIT__\\n" + img_base64
`;

      try {
        const result = await pyodide.runPythonAsync(pythonCode);
        const [logText, imgBase64] = result.split("__SPLIT__");
        outputEl.textContent = logText;
        if (imgBase64) {
          imgEl.src = "data:image/png;base64," + imgBase64;
        } else {
          imgEl.src = "";
        }
      } catch (err) {
        outputEl.textContent = "❌ Pyodide 実行エラー:\n" + err;
        imgEl.src = "";
        console.error(err);
      }
    }
  </script>
</body>
</html>