<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å¤§é­”ç‹ã´ã‚ˆã¾ã‚‹æ§˜ã®å´‡é«˜ãªã‚¢ãƒ—ãƒª(WEBç‰ˆ)</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      text-align: center; 
    }
    pre { 
      background: #f0f0f0; 
      padding: 10px; 
      white-space: pre-wrap; 
      margin: 0 auto; 
      max-width: 600px; 
    }
    img { 
      max-width: 100%; 
      margin-top: 10px; 
    }
    .container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 10px; 
    }
    #password-screen, #main-content { 
      display: none; 
    }
    #password-screen.active, #main-content.active { 
      display: block; 
    }
  </style>
</head>
<body>
  <div id="password-screen" class="active">
    <h1>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h1>
    <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="checkPassword()">é€ä¿¡</button>
    <p id="password-error" style="color: red;"></p>
  </div>

  <div id="main-content" class="container">
    <h1>å¤§é­”ç‹ã´ã‚ˆã¾ã‚‹æ§˜ã®å´‡é«˜ãªã‚¢ãƒ—ãƒª(WEBç‰ˆ)</h1>

    <label for="threshold">é–¾å€¤ (0ã€œ1):</label>
    <input type="number" id="threshold" min="0" max="1" step="0.0001" value="0.9500"><br>

    <label for="imageInput">å¯¾è±¡ç”»åƒ (.png, .jpg, .jpeg):</label>
    <input type="file" id="imageInput" accept="image/*"><br>

    <button onclick="runMatching()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

    <h2>çµæœãƒ­ã‚°:</h2>
    <pre id="output">ã“ã“ã«ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</pre>

    <h2>ãƒãƒƒãƒçµæœç”»åƒ:</h2>
    <img id="resultImage" src="" alt="ãƒãƒƒãƒçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™">
  </div>

  <script>
    const CORRECT_PASSWORD = "kanatanpyonsu";
    const TEMPLATE_URL = "https://raw.githubusercontent.com/Gorzmonst/monst25/main/1v2iPhone16_2.png"; // ãƒªãƒã‚¸ãƒˆãƒªã«åŸºã¥ãURL

    function checkPassword() {
      const input = document.getElementById("password-input").value;
      const errorEl = document.getElementById("password-error");
      if (input === CORRECT_PASSWORD) {
        document.getElementById("password-screen").classList.remove("active");
        document.getElementById("main-content").classList.add("active");
      } else {
        errorEl.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚";
      }
    }

    let pyodide = null;

    async function loadPyodideAndPackages() {
      pyodide = await loadPyodide();
      await pyodide.loadPackage(["opencv-python", "numpy"]);
    }

    loadPyodideAndPackages();

    async function runMatching() {
      const threshold = parseFloat(document.getElementById("threshold").value);
      const imageInput = document.getElementById("imageInput");
      const outputEl = document.getElementById("output");
      const imgEl = document.getElementById("resultImage");

      if (imageInput.files.length === 0) {
        outputEl.textContent = "â— å¯¾è±¡ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
        imgEl.src = "";
        return;
      }

      if (isNaN(threshold) || threshold < 0 || threshold > 1) {
        outputEl.textContent = "â— é–¾å€¤ã¯ 0ã€œ1 ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        imgEl.src = "";
        return;
      }

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã‚’GitHubã‹ã‚‰ãƒ•ã‚§ãƒƒãƒ
      const templateResponse = await fetch(TEMPLATE_URL);
      if (!templateResponse.ok) {
        outputEl.textContent = "âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        return;
      }
      const templateArrayBuffer = await templateResponse.arrayBuffer();
      const templateBytes = new Uint8Array(templateArrayBuffer);
      pyodide.FS.writeFile('template.png', templateBytes);

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’å‡¦ç†
      const imageFile = imageInput.files[0];
      const imageExt = imageFile.name.split('.').pop().toLowerCase();
      const imageName = "uploaded." + imageExt;
      const imageBytes = new Uint8Array(await imageFile.arrayBuffer());
      pyodide.FS.writeFile(imageName, imageBytes);

      const pythonCode = `
import cv2
import numpy as np
import base64

log = []
try:
    log.append("ğŸ”¹ template èª­ã¿è¾¼ã¿ä¸­...")
    template = cv2.imread("template.png", 0)
    if template is None:
        raise Exception("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—")

    log.append("ğŸ”¹ å¯¾è±¡ç”»åƒ èª­ã¿è¾¼ã¿ä¸­...")
    img_color = cv2.imread("${imageName}")
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)

    log.append("ğŸ”¹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œä¸­...")
    res = cv2.matchTemplate(img_gray, template, cv2.TM_CCOEFF_NORMED)
    log.append("ğŸ”¹ é–¾å€¤ ${threshold} ä»¥ä¸Šã‚’æŠ½å‡ºä¸­...")
    loc = np.where(res >= ${threshold})
    result = list(zip(*loc[::-1]))

    min_distance = 10
    final_result = []
    for pt in result:
        add = True
        for other_pt in final_result:
            dist = np.linalg.norm(np.array(pt) - np.array(other_pt))
            if dist < min_distance:
                add = False
                break
        if add:
            final_result.append(pt)

    final_result_sorted = sorted(final_result, key=lambda x: x[0])

    if final_result_sorted:
        log.append("âœ… ãƒãƒƒãƒç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:")
        if len(final_result_sorted) > 5:
            log.append("âš ï¸ ãƒãƒƒãƒç®‡æ‰€ãŒå¤šã™ãã¾ã™ã€‚é–¾å€¤ã‚’èª¿æ•´ã™ã‚‹ã‹ã€ç¯„å›²ã‚’ç‹­ã‚ã¦ãã ã•ã„ã€‚")
        h, w = template.shape
        for pt in final_result_sorted:
            log.append(f"ãƒãƒƒãƒç®‡æ‰€ å·¦ä¸Šåº§æ¨™: X: {pt[0]}, Y: {pt[1]}")
            center_x = pt[0] + w // 2
            center_y = pt[1] + h // 2
            log.append(f"ãƒãƒƒãƒç®‡æ‰€ ä¸­å¿ƒåº§æ¨™: X: {center_x}, Y: {center_y}")
            cv2.rectangle(img_color, pt, (pt[0] + w, pt[1] + h), (0, 0, 255), 2)
            cv2.circle(img_color, (center_x, center_y), 10, (0, 255, 0), 2)
    else:
        log.append("âš ï¸ ãƒãƒƒãƒãªã—")

    cv2.imwrite("result.png", img_color)

    with open("result.png", "rb") as f:
        img_bytes = f.read()
    img_base64 = base64.b64encode(img_bytes).decode("utf-8")

except Exception as e:
    log.append("âŒ ã‚¨ãƒ©ãƒ¼: " + str(e))
    img_base64 = ""

"\\n".join(log) + "\\n__SPLIT__\\n" + img_base64
`;

      try {
        const result = await pyodide.runPythonAsync(pythonCode);
        const [logText, imgBase64] = result.split("__SPLIT__");
        outputEl.textContent = logText;
        if (imgBase64) {
          imgEl.src = "data:image/png;base64," + imgBase64;
        } else {
          imgEl.src = "";
        }
      } catch (err) {
        outputEl.textContent = "âŒ Pyodide å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:\n" + err;
        imgEl.src = "";
        console.error(err);
      }
    }
  </script>
</body>
</html>